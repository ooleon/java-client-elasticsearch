name: Docker Image CI

on: [push]

jobs:      

  ElasticSearch1:

    runs-on: ubuntu-latest

    steps:
    - uses: getong/elasticsearch-action@v1
      with:
        elasticsearch version: '5.6.16'
        host port: 9200
        container port: 9200
        discovery type: 'single-node'
    
    - name: Run the Docker image mvn -v
      run: mvn -v

    - name: Up  work's Directory
      run:  ls -l
          & cd /home/runner/work
          & ls -l
          & cd /home/runner/work/java-client-elasticsearch 
          & ls -l
          & cd /home/runner/work/java-client-elasticsearch/java-client-elasticsearch
          & ls -l

           #docker build . --file Dockerfile --tag my-image-name:$(date +%s)

    - name: Run the Docker image Test
      run: ls -l

    - name: Run the Docker image ESMainTest
      run: mvn test -Dtest=ESMainTest test

    - name: Run the Docker image curl elastic
      run: curl http://127.0.0.1:9200/_cat/health


#      run: docker run -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:5.6.16

  test:

    runs-on: ubuntu-latest

    steps:
#    - uses: getong/elasticsearch-action@v1
    - uses: actions/checkout@v2
    - name: Test the Docker image through mvn
      run:  cd /home/runner/work/java-client-elasticsearch 
          & ls -l  
          & mvn -v #docker build . --file Dockerfile --tag my-image-name:$(date +%s)


    # - name: Run tests
    #   run: |
    #     if [ -f docker-compose.test.yml ]; then
    #       docker-compose --file docker-compose.test.yml build
    #       docker-compose --file docker-compose.test.yml run sut
    #     else
    #       docker build . --file Dockerfile
    #     fi


  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag my-image-name:$(date +%s)


